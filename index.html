<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Колода 78 карт — WebApp</title>
  <style>
    html { background-image: url('./cards/bg.jpg'); background-repeat: no-repeat; background-repeat: no-repeat; background-position: center; }
    body { font-family: Arial, sans-serif; padding: 16px; width: 340px; height: 620px; margin: auto; text-align: center; }
    #deck { height: 260px; width: 165px; cursor: pointer; margin-left: 27%; margin-top: 7%;}
    #controls { margin-top: 0; height: 40px;}
    button { padding: 8px 12px; font-size: 16px; }
    #drawn { height: 200px; width: 320px; margin-top: 6px; display:flex; flex-wrap:wrap; justify-content:center; gap:12px; }
    .drawn-card { width:80px; text-align:center; border:1px solid #e0e0e0; padding:8px; border-radius:6px; background:#fafafa; }
    .drawn-card img { width:100%; height:auto; display:block; }
    .card-caption { margin-top:6px; font-size:14px; }
    #info { margin-top:6px; min-height:18px; }
  </style>
</head>
<body>
  <h2>Тянем 3 карты</h2>
  <p>Нажмите на колоду, чтобы вытянуть карту. Повторите 3 раза.</p>

  <div id="deck" alt="Deck"></div>
  <div id="info"></div>

  <div id="controls">
    <button id="reset" style="display:none;">Сбросить и начать заново</button>
  </div>

  <!-- Контейнер для всех вытянутых карт -->
  <div id="drawn"></div>

<script>
  // Список карт формируется так же, как и на сервере.
  const majors = [
    "Шут", "Маг", "Верховная Жрица", "Императрица", "Император", "Иерофант",
    "Влюблённые", "Колесница", "Сила", "Отшельник", "Колесо Фортуны",
    "Справедливость", "Повешенный", "Смерть", "Умеренность", "Дьявол",
    "Башня", "Звезда", "Луна", "Солнце", "Суд", "Мир"
  ];

  const suits = ["Мечей", "Жезлов", "Пентаклей", "Кубков"];
  const ranks = ["Туз", "2", "3", "4", "5", "6", "7", "8", "9", "10", "Паж", "Рыцарь", "Королева", "Король"];

  const cards = [];
  // Major arcana (22)
  for (let i = 0; i < majors.length; i++) {
    cards.push(majors[i]);
  }
  // Minor (56)
  for (let s = 0; s < suits.length; s++) {
    for (let r = 0; r < ranks.length; r++) {
      cards.push(`${ranks[r]} ${suits[s]}`);
    }
  }
  // Теперь cards.length === 78

  // Настройте базовый URL для изображений карт (должен быть доступен через HTTP/HTTPS)
  // Пример: "https://example.com/cards" или относительная папка "./cards"
  const CARDS_BASE_URL = "https://vladimirsharap.github.io/TG_bot.github.io/cards";

  document.addEventListener('DOMContentLoaded', () => {
    // Совместимая проверка (без ?. на случай старых сред)
    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

    if (!tg) {
      // Показываем сообщение аккуратно в элементе, не стирая весь body
      const info = document.getElementById('info') || document.createElement('div');
      info.id = 'info';
      info.textContent = 'Откройте эту страницу внутри Telegram (Web App).';
      if (!document.getElementById('info')) document.body.prepend(info);

      console.warn('Not in Telegram WebApp');
      return;
    }

    // Делаем доступным глобально, если в других местах вы проверяете typeof tg
    window.tg = tg;

    // Можно попытаться развернуть Web App
    try {
      tg.expand();
    } catch (e) {
      console.warn('tg.expand() failed:', e);
    }

    // Любая другая инициализация WebApp
  });

  // Telegram WebApp (tg предполагается доступным в окружении WebApp)
  const deckImg = document.getElementById("deck");
  const info = document.getElementById("info");
  const resetBtn = document.getElementById("reset");
  const drawnContainer = document.getElementById("drawn");

  // Копируем и тасуем колоду на клиенте
  let deck = shuffle(Array.from({length: 78}, (_, i) => i));
  let draws = [];

  function shuffle(array) {
    // Fisher-Yates
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  deckImg.addEventListener('click', () => {
    if (draws.length >= 3) return;
    if (deck.length === 0) {
      info.textContent = "Колода пустая.";
      return;
    }

    const idx = deck.pop(); // индекс карты 0..77
    const name = cards[idx];
    const imageUrl = `${CARDS_BASE_URL}/${idx}.jpg`; // изображения должны быть по этим ссылкам

    // Формируем payload для отправки боту
    const payload = {
      type: "draw",
      index: idx,
      name: name,
      image: imageUrl,
      position: draws.length + 1
    };

    // Создаём DOM-блок для новой вытянутой карты и добавляем в контейнер
    const cardEl = document.createElement('div');
    cardEl.className = 'drawn-card';
    cardEl.innerHTML = `
      <img src="${imageUrl}" alt="${name}">
      <div class="card-caption"><b>Карта ${payload.position}:</b> ${name}</div>
    `;
    drawnContainer.appendChild(cardEl);

    // Показываем краткую информацию
    info.innerHTML = `Вытянуто: ${draws.length + 1}/3`;

    // Отправляем данные боту (если tg доступен)
    try {
      if (typeof tg !== 'undefined' && tg.sendData) {
        tg.sendData(JSON.stringify(payload));
      } else {
        // В режиме разработки можно логировать
        console.log('tg.sendData not available, payload:', payload);
      }
    } catch (e) {
      console.error("sendData failed:", e);
    }

    draws.push(payload);

    if (draws.length >= 3) {
      resetBtn.style.display = "inline-block";
    }
  });

  resetBtn.addEventListener('click', () => {
    deck = shuffle(Array.from({length: 78}, (_, i) => i));
    draws = [];
    drawnContainer.innerHTML = '';
    info.textContent = '';
    resetBtn.style.display = 'none';
  });
</script>
</body>
</html>