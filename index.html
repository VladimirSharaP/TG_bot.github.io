<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Колода 78 карт — WebApp</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html { background-image: url('./cards/bg.jpg'); background-repeat: no-repeat; background-position: center; height: 100%; }
    body { font-family: Arial, sans-serif; padding: 3px 16px; width: 340px; height: 99vh; margin: auto; text-align: center; }
    #deck { height: 260px; width: 165px; cursor: pointer; margin-left: 27%; margin-top: 19%; outline: none; border-radius:8px; background-size: cover; background-position: center; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    #deck:focus { outline: none; -webkit-tap-highlight-color: rgba(255, 255, 255, 0); }
    h2 { margin: 7px; }
    p { margin: 0; }
    #controls { margin-top: 0; height: 40px;}
    button { padding: 8px 12px; font-size: 16px; }
    #drawn { height: 195px; width: 350px; margin-top: 6px; display:flex; flex-wrap:wrap; justify-content:center; gap:12px; }
    .drawn-card { width:90px; text-align:center; border:1px solid #e0e0e0; padding:8px; border-radius:6px; background:#fafafa; }
    .drawn-card img { width:100%; height:auto; display:block; border-radius:4px; }
    .card-caption { margin-top:6px; font-size:14px; }
    #info { margin: 2px; min-height:18px; }
    #sendHint { font-size:12px; color:#666; margin-top:6px; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
  function findTelegramWebApp() {
    return window.Telegram?.WebApp
        || window.parent?.Telegram?.WebApp
        || window.top?.Telegram?.WebApp
        || null;
  }

  function waitForTelegramWebApp(timeout = 5000, interval = 150) {
    const start = Date.now();
    return new Promise(resolve => {
      (function poll() {
        const tg = findTelegramWebApp();
        if (tg) return resolve(tg);
        if (Date.now() - start > timeout) return resolve(null);
        setTimeout(poll, interval);
      })();
    });
  }

  (async function init() {
    const tg = await waitForTelegramWebApp(5000);
    if (!tg) {
      console.warn('Telegram.WebApp not found — возможно, открыто вне Telegram или объект ещё не внедрён.');
      document.body.insertAdjacentHTML('beforeend',
        '<div style="color:orange">Telegram WebApp object not found — open inside Telegram.</div>');
      return;
    }

    // Сохраним ссылку для отладки
    window.tg = tg;

    try {
      if (typeof tg.expand === 'function') {
        tg.expand();
        console.log('tg.expand() called');
      } else {
        console.info('tg.expand is not available in this client');
      }
    } catch (e) {
      console.error('Error calling tg.expand():', e);
    }
  })();
</script>
</head>
<body>
  <h2>Тянем 3 карты</h2>
  <p>Нажмите на колоду, чтобы вытянуть карту.</p>
  <div id="deck" alt="Deck" title="Нажмите, чтобы вытянуть карту"></div>
  <div id="info"></div>
  <div id="controls">
    <button id="reset" style="display:none;">Сбросить и начать заново</button>
  </div>
  <div id="drawn"></div>
  <div id="sendHint"></div>

<script>
  // Таро: 22 старших + 56 младших = 78 карт
  const majors = [
    "Шут", "Маг", "Верховная Жрица", "Императрица", "Император", "Иерофант",
    "Влюблённые", "Колесница", "Сила", "Отшельник", "Колесо Фортуны",
    "Справедливость", "Повешенный", "Смерть", "Умеренность", "Дьявол",
    "Башня", "Звезда", "Луна", "Солнце", "Суд", "Мир"
  ];
  const suits = ["Мечей", "Жезлов", "Пентаклей", "Кубков"];
  const ranks = ["Туз", "2", "3", "4", "5", "6", "7", "8", "9", "10", "Паж", "Рыцарь", "Королева", "Король"];
  const cards = [];

  // Major arcana (22)
  for (let i = 0; i < majors.length; i++) {
    cards.push(majors[i]);
  }
  // Minor (56)
  for (let s = 0; s < suits.length; s++) {
    for (let r = 0; r < ranks.length; r++) {
      cards.push(`${ranks[r]} ${suits[s]}`);
    }
  }

  const CARDS_BASE_URL = "https://vladimirsharap.github.io/TG_bot.github.io/cards";

  let deck = [];
  let draws = [];

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function initDeck() {
    deck = shuffle(Array.from({length: 78}, (_, i) => i));
  }

  function updateInfo(text) {
    document.getElementById('info').textContent = text || '';
  }

  function addDrawnCard(idx) {
    const name = cards[idx] || $`{idx}`;
    const imageUrl = CARDS_BASE_URL + "/" + idx + ".jpg";
    const cardEl = document.createElement('div');
    cardEl.className = 'drawn-card';
    cardEl.innerHTML = `
      <div>
        <img src="${imageUrl}" alt="${name}" onerror="this.style.opacity=0.6; this.title='Image not found';" />
        <div class="card-caption">${name}</div>
      </div>
    `;
    document.getElementById('drawn').appendChild(cardEl);
  }

  function enableReset(show = true) {
    const resetBtn = document.getElementById('reset');
    resetBtn.style.display = show ? 'inline-block' : 'none';
  }

  function sendSelectionToBot() {
    if (!window.tg) {
      document.getElementById('sendHint').textContent = 'Не в Telegram WebApp — данные не отправлены.';
      return;
    }
    // Формируем полезные данные: индекс, название и ссылка на изображение
    const payload = {
      cards: draws.map(i => ({
        index: i,
        name: cards[i],
        image: CARDS_BASE_URL + "/" + i + ".jpg"
      }))
    };
    try {
      window.tg.sendData(JSON.stringify(payload));
      document.getElementById('sendHint').textContent = 'Выбор отправлен боту.';
    } catch (err) {
      console.error('sendData error', err);
      document.getElementById('sendHint').textContent = 'Ошибка при отправке данных боту.';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const deckEl = document.getElementById('deck');
    const resetBtn = document.getElementById('reset');
    const drawnContainer = document.getElementById('drawn');

    initDeck();
    updateInfo('Готово. Вытяните 3 карты.');

    deckEl.addEventListener('click', () => {
      if (draws.length >= 3) {
        updateInfo('Вы уже вытянули 3 карты. Нажмите "Сбросить и начать заново".');
        return;
      }
      if (deck.length === 0) {
        updateInfo('Колода пуста.');
        return;
      }
      const idx = deck.pop();
      draws.push(idx); // Важно — сохраняем вытянутую карту
      addDrawnCard(idx);
      updateInfo("Вытянуто: " + draws.length + "/3");

      if (draws.length === 3) {
        enableReset(true);
        // Отправляем данные боту
        sendSelectionToBot();
      }
    });

    resetBtn.addEventListener('click', () => {
      initDeck();
      draws = [];
      drawnContainer.innerHTML = '';
      updateInfo('Колода перетасована. Вытяните 3 карты.');
      enableReset(false);
      document.getElementById('sendHint').textContent = '';
    });
  });
</script>
</body>
</html>
